<!DOCTYPE html>
<html lang="jp">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ミッション一覧</title>
</head>

<body>
	<h1>ミッション選択画面</h1>

	<div id=quest hidden>
		<h2>今日のミッション</h2>
		<h3>問題</h3>
		<p id="question"></p>
		<h4>選択肢</h4>
		<form id="answer-list"></form>
		<Button id="answer-send">回答送信！</Button>
		res:<br>
		<textarea id="ta" style="width:60vw; height:8em;"></textarea>
	</div>

	<h2>ミッション一覧</h2>
	<ul id="quests"></ul>
	<script type="module">
		import { fetchJSON } from "https://code4sabae.github.io/js/fetchJSON.js";
		import { getUuid } from "./util.js";

		let questJson = {};
		let selectedQuestid = undefined;

		getQuest();

		const submitBtn = document.getElementById("answer-send");
		submitBtn.onclick = async () => {
			const uuid = getUuid();
			if (uuid === undefined) {
				ta.value = "idが割り振られていません";
			}
			else {
				const form = document.getElementById("answer-list");
				const list = form.choices;
				const answer = parseInt(list.value);
				if (isNaN(answer)) {
					ta.value = "回答が選択されていません";
				} else {
					const res = await fetchJSON("/api/sendanswer", {
						userid: uuid, questid: selectedQuestid, answer: answer,
					});
					ta.value = JSON.stringify(res);
				}
			}
		}

		async function getQuest() {
			questJson = await (await fetch("/api/getquest")).json();
			for (let i = 0; i < questJson.length; i++) {
				const li = document.createElement("li");
				li.textContent = questJson[i].question;
				li.onclick = () => {
					selectedQuestid = i;
					question.textContent = questJson[i].question;

					const answerList = document.getElementById("answer-list");
					answerList.innerHTML = "";
					questJson[i].answerList.forEach((e, idx) => {
						const lavel = document.createElement("label");
						const choice = document.createElement("input");
						choice.type = "radio";
						choice.name = "choices";
						choice.value = idx;
						choice.textContent = e;
						lavel.appendChild(choice);
						const text = document.createTextNode(e);
						lavel.appendChild(text);
						answerList.appendChild(lavel);
					});
					quest.hidden = false;
				}
				quests.appendChild(li);
			}
		}

	</script>
</body>

</html>