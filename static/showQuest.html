<!DOCTYPE html>
<html lang="jp">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="./showQuest.css">
	<title>ミッション一覧</title>
</head>

<body>
	<header>

	</header>
	<br>
	<h1>ミッション選択画面</h1>
	<hr color="red">
	<div id=quest hidden>
		<br>
		<div class="kokuban-s2">
			<h2>・今日のミッション</h2>
			<br>
			<h3>問題</h3>

			<p id="question"></p>
			<br>
			<h3>選択肢</h3>
			<form id="answer-list"></form>
		</div>
		<br>
		<Button id="answer-send">回答送信！</Button>

		<br><br>
		<p1>

			<div id="answer-div" hidden>
				<h4>結果</h4>

			</div>
	</div>

	<br><br><br>
	<h2>・ミッション一覧</h2>
	<br><br>
	<div id="missions">

		<div class="cp_ipselect cp_sl04">
			<span style="color:white">並び順：</span>
			<select id="sort-type">
				<option value="standard">標準 </option>
				<option value="difficulty-up">難易度（昇順）</option>
				<option value="difficulty-down">難易度（降順）</option>
				<option value="point">獲得ポイント</option>
			</select>
		</div>
		<div class="box5">
			<ul class="sample1">
				<ul id="quests"></ul>
				</ol>
		</div>
	</div>


	<script type="module">
		import { fetchJSON } from "https://code4sabae.github.io/js/fetchJSON.js";
		import { getUuid } from "./util.js";

		let uuid = "";
		let getJSON = {};
		let questJson = [];
		let selectedQuestid = undefined;
		window.onload = async () => {
			uuid = await getUuid();

			getQuest();
		}

		const submitBtn = document.getElementById("answer-send");
		submitBtn.onclick = async () => {
			const form = document.getElementById("answer-list");
			const list = form.choices;
			const answer = parseInt(list.value);
			if (isNaN(answer)) {
				window.alert("回答が選択されていません");
			} else {
				const res = await fetchJSON("/api/checkans", {
					id: uuid,
					questId: selectedQuestid,
					answer: answer,
				});

				let text = "";
				const answerDiv = document.getElementById("answer-div");

				if (res.result === "correct") {
					text = "正解！！！";
				} else if (res.result === "incorrect") {
					text = `不正解！<br>正解は${questJson[selectedQuestid].answerList[res.answer]}でした！`;
				} else if (res.result === "timeover") {
					text = `時間切れ～！<br>正解は${questJson[selectedQuestid].answerList[res.answer]}でした！`;
				}
				else {
					text = JSON.stringify(res);
				}
				answerDiv.childNodes[1].innerHTML = text;

				answerDiv.hidden = false;
				document.getElementById("answer-send").disabled = true;
				form.childNodes.forEach(item => item.childNodes[0].disabled = true);
				quests.childNodes.forEach(item => item.onclick = null);
			}
		}

		async function getQuest() {
			getJSON = await fetchJSON("/api/getquest", { id: uuid });
			console.log(getJSON);
			if (getJSON.res !== "OK") {
				if (getJSON.res === "notset") {
					window.alert("アラームが設定されていません。\nトップページに移動します。");
				} else if (getJSON.res === "early") {
					window.alert("設定時刻前です。\n設定時刻より後にもう一度アクセスしてください。\nトップページに移動します。");
				} else if (getJSON.res === "timeover") {
					window.alert("時間切れです。明日はちゃんとおきましょう。\nトップページに移動します。");
				}

				window.open("/index.html", "_self");
			} else {
				questJson = getJSON.quests;
				document.getElementById("sort-type").onchange();
			}
		}

		document.getElementById("sort-type").onchange = function () {
			const difficultyList = ["S", "A", "B", "C", "D", "E"];
			let questList = [];
			if (this.value === "standard") {
				// アラーム設定時の難易度設定によって変える
				questList = questList.concat(questJson.filter(e => e.difficulty === getJSON.difficultyChoice));
				questList = questList.concat(questJson.filter(e => e.difficulty !== getJSON.difficultyChoice));

				//questList = questList.concat(questJson);
			} else if (this.value === "difficulty-up") {
				difficultyList.forEach(d => {
					questList = questList.concat(questJson.filter(e => e.difficulty === d));
				});
			} else if (this.value === "difficulty-down") {
				difficultyList.reverse().forEach(d => {
					questList = questList.concat(questJson.filter(e => e.difficulty === d));
				});
			} else if (this.value === "point") {
				questList = questList.concat(questJson);
				questList.sort((a, b) => b.point - a.point);
			}

			// リスト作成
			quests.innerHTML = "";
			for (let i = 0; i < questList.length; i++) {
				const li = document.createElement("li");
				li.textContent = `${questList[i].question} 難易度：${questList[i].difficulty} ポイント：${questList[i].point}`;
				console.log(li.onclick);
				li.onclick = () => {
					selectedQuestid = questList[i].questId;
					question.textContent = questList[i].question;

					const answerList = document.getElementById("answer-list");
					answerList.innerHTML = "";
					questList[i].answerList.forEach((e, idx) => {
						const lavel = document.createElement("label");
						const choice = document.createElement("input");
						choice.type = "radio";
						choice.name = "choices";
						choice.value = idx;
						choice.textContent = e;
						lavel.appendChild(choice);
						const text = document.createTextNode(e);
						lavel.appendChild(text);
						answerList.appendChild(lavel);
					});
					quest.hidden = false;
				}
				quests.appendChild(li);
			}
		}

	</script>

</body>

</html>