<!DOCTYPE html>
<html lang="jp">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロフィール</title>
</head>

<body>
    <header>
        <a href="index.html"><img src="logo.png" height="40px"></a>
    </header>
    <hr>
    <br><br>

    <h1 class="midashi">プロフィール</h1>

    <form id="quest-form">
        <div>
            <label>ID：<span id="id"></span></label>
        </div>
        <div>
            <label>表示名：<input type="text" id="screenname" disabled></input></label>
        </div>
        <div>
            <label>自己紹介文：<textarea id="introduction" disabled></textarea></label>
        </div>
        <div>
            <label>今日の問題を解いたか：<span id="solution"></span></label>
        </div>
        <div>
            <label>今までに解いた問題数：<span id="solved"></span></label>
        </div>
        <div>
            <label>現在のポイント：<span id="point"></span></label>
        </div>
        <div>
            <label>ランキング：<span id="rank">-</span>位</label>
        </div>
        <input type="submit" id="updatebtn" value="プロフィール更新！" disabled></input>

    </form>
    <h2 id="result"></h2>

    <footer>
        <a href="index.html"><img src="ranking.gif" class="pos"></a>
        <a href="index.html">
            <div class="balloon2-left">
                <p>トップページにもどる</p>
        </a>
        </div>

    </footer>
    <script type="module">
        import { fetchJSON } from "https://code4sabae.github.io/js/fetchJSON.js";
        import { showNotification, getUuid } from "./util.js";

        let uuid = undefined;
        window.onload = async () => {
            showNotification();
            uuid = await getUuid();

            const queryUuid = getQueryId();
            await getProfile(queryUuid);
        }

        document.getElementById("quest-form").onsubmit = async (e) => {
            e.preventDefault();

            const res = await fetchJSON("/api/setprofile", {
                id: uuid,
                name: screenname.value,
                icon: 0,
                introduction: introduction.value,
            });
            console.log(res);
        }

        const getProfile = async (showUuid) => {
            const profile = await fetchJSON("/api/getprofile", { id: showUuid });
            console.log(profile);
            /*const profile = {
                id: showUuid,
                name: "すずとも",
                icon: 0,
                introduction: "自己紹介文です！",
                prevTime: 1598420700000,
                solution: false,
                solved: [1, 3, 5],
                point: 30,
                rank: 1,
            }*/

            if (showUuid === uuid) {
                screenname.disabled = false;
                introduction.disabled = false;
                updatebtn.disabled = false;
            }

            id.textContent = uuid;
            screenname.value = profile.name;
            introduction.value = profile.introduction;
            solution.textContent = profile.solution ? "解いた" : "まだ解いてない";
            solved.textContent = profile.solved.length;
            point.textContent = profile.point;
            rank.textContent = profile.rank;

        }

        function getQueryId() {
            var queryString = window.location.search;
            var queryObject = new Object();
            if (queryString) {
                queryString = queryString.substring(1);
                var parameters = queryString.split('&');

                for (var i = 0; i < parameters.length; i++) {
                    var element = parameters[i].split('=');

                    var paramName = decodeURIComponent(element[0]);
                    var paramValue = decodeURIComponent(element[1]);

                    queryObject[paramName] = paramValue;
                }
            }
            return queryObject.id;
        }

    </script>
</body>

</html>