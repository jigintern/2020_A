<!DOCTYPE html>
<html lang="jp">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="./setAlarm.css">
	<title>時刻設定</title>

</head>

<body>
	<header>
		<a href="index.html"><img src="logo.png" height="40px"></a>
	</header>

	
<hr>
<br><br>
	
		<h1>起床時間の設定</h1>
	
	

	<br><br><br>

	<center>
	
			<font1 id="time"></font1>
		
	</center>

	<br><br>

	<script>
		time();
		function time() {
			var now = new Date();
			document.getElementById("time").innerHTML = now.toLocaleString();
		}
		setInterval('time()', 1000);
	</script>

	<form id="input-form">

		<br><br>
		<center>
		
				<input type="datetime-local" id="datetime" size=50 style="font-size:30px;" required>

			<div>
				<span>現在設定されてる時刻：</span>
				<span id="nowset-time"></span>
			</div>
			<div>
				<span>前回設定した時刻：</span>
				<span id="lastset-time"></span>
			</div>

			<br>
			<div class="cp_ipselect cp_sl04">
				<span style="color:white">難易度：</span>
				<select name="difficulty" id="difficulty">
					<option value="">なし</option>
					<option value="S">S</option>
					<option value="A">A</option>
					<option value="B">B</option>
					<option value="C">C</option>
					<option value="D">D</option>
					<option value="E">E</option>
				</select>
			</div>
			<br><br>
			<input type="submit" value"送信" class="button">
		</center>

		<h3 id="set-result"></h3>

		<br>

	</form>
	<br><br><br>


	<br><br>

	<script type="module">
		import { fetchJSON } from "https://code4sabae.github.io/js/fetchJSON.js";
		import { showNotification, getUuid } from "./util.js";

		var uuid = undefined;

		window.onload = async () => {
			uuid = await getUuid();
			console.log(uuid);

			showNotification(uuid);

			const date = new Date();
			const now = {
				Y: ("0000" + date.getFullYear()).slice(-4),
				M: ("00" + (date.getMonth() + 1)).slice(-2),
				D: ("00" + date.getDate()).slice(-2),
				h: ("00" + date.getHours()).slice(-2),
				m: ("00" + date.getMinutes()).slice(-2),
			}
			datetime.value = `${now.Y}-${now.M}-${now.D}T${now.h}:${now.m}`;

			const getData = await fetchJSON("/api/getalarm", { id: uuid });
			//console.log(new Date(getData.time).toLocaleString());
			document.getElementById("nowset-time").textContent = new Date(getData.time).toLocaleString();

			const lastsetTime = document.getElementById("lastset-time");
			if (getData.prevTime === null) lastsetTime.textContent = "-";
			else lastsetTime.textContent = new Date(getData.prevTime).toLocaleString();
		}

		const inputForm = document.getElementById("input-form");
		inputForm.addEventListener('submit', async (event) => {
			event.preventDefault();

			const utc = new Date(datetime.value).getTime();

			console.log(datetime.value);
			const status = document.getElementById("status");
			if (isNaN(utc)) {
				window.alert("入力したデータが無効です");
			} else {
				const res = await fetchJSON("/api/setalarm", {
					id: uuid, time: utc, difficultyChoice: difficulty.value
				});
				//ta.value = JSON.stringify(res);
				const setResult = document.getElementById("set-result");

				if (res.res === "OK") {
					setResult.textContent = "アラーム設定完了！";
					showNotification(uuid);
				}
			}
		});

	</script>
	<footer>
		<a href="index.html">-トップページに戻る-</a>
	</footer>
</body>

</html>