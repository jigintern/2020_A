<!DOCTYPE html>
<html lang="jp">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>時刻設定</title>
</head>

<body>
  <h1>起床時間の設定</h1>
  <p id="RealtimeClockArea"></p>
  <script>
    var today = new Date();
    var year = today.getFullYear();
    var month = today.getMonth() + 1;
    var week = today.getDay();
    var day = today.getDate();
    var week_ja = new Array("日", "月", "火", "水", "木", "金", "土");
    document.write(year + "年" + month + "月" + day + "日" + week_ja[week] + "曜日");
  </script>
  <script>
    async function set(e) {
      const data = document.getElementById("time");
      const utc = new Date(data.value);

      utc.getTime();
      console.log(new Date(utc.getTime()));

      const resJson = {
        utc: utc.getTime()
      };

      await fetch("/api/set", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(resJson),
      });
    }
  </script>

  <form id="input-form">
    <input type="datetime-local" id="datetime">
    <input type="submit" value="送信">
  </form>
  res:<br>
  <textarea id="ta" style="width:60vw; height:8em;"></textarea>

  <script type="module">
    import { fetchJSON } from "https://code4sabae.github.io/js/fetchJSON.js";

    window.onload = () => {
      // 通知を許可するかユーザに問いかける
      navigator.serviceWorker.register("sw.js").then(() => {
        Notification.requestPermission(function (permission) {
          if (permission === 'denied') {
            alert('プッシュ通知を有効にできません。ブラウザの設定を確認して下さい。');
          }
        });
      });
    }

    const inputForm = document.getElementById("input-form");
    inputForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      
      const utc = new Date(datetime.value).getTime();
      
      const status = document.getElementById("status");
      if (isNaN(utc)) {
        ta.value = "入力したデータが無効です";
      } else {
        const res = await fetchJSON("/api/setalarm", {id:0,time:utc});
        ta.value  = JSON.stringify(res);
      }
    });
  </script>
</body>

</html>