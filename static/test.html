<html>
    <head>
        <link rel="manifest" href="/manifest.json">
    </head>
    <body>
        <h1>FCM push notification test</h1>

        <p>
            <input type="button" id="btnSubscribe" value="通知を許可する">
            <input type="button" id="btnUnSubscribe" value="トークン削除" style="display:none;">
        </p>
        <p><input type="text" value="YOUR-INCETANCE-ID-TOKEN" id="textInstanceIdToken" style="width:100%;box-sizing:border-box;"></p>
        <div id="sendWebPushArea" style="display:none;">
            <p>下記をコピーしてこのタブを閉じ、別ブラウザで見てください</p>
            <input type="text" value="" id="sendWebPush" style="width:100%;box-sizing:border-box;">
        </div>

        <!-- The core Firebase JS SDK is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/7.19.0/firebase-app.js"></script>

        <!-- TODO: Add SDKs for Firebase products that you want to use
            https://firebase.google.com/docs/web/setup#available-libraries -->

        <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyAJ5fAul7BN8YYAy246nx9q4NgCLPOuJNU",
            authDomain: "jigintern2020-a-team.firebaseapp.com",
            databaseURL: "https://jigintern2020-a-team.firebaseio.com",
            projectId: "jigintern2020-a-team",
            storageBucket: "jigintern2020-a-team.appspot.com",
            messagingSenderId: "308664219290",
            appId: "1:308664219290:web:03a88bd8d7e4f06e459123"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        </script>

        <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase-messaging.js"></script>





        <script type="module">
            import { fetchJSON } from "https://code4sabae.github.io/js/fetchJSON.js";
            const btnSubscribe = document.getElementById('btnSubscribe');
            const btnUnSubscribe = document.getElementById('btnUnSubscribe');
            const textInstanceIdToken = document.getElementById('textInstanceIdToken');
            const sendWebPushArea = document.getElementById('sendWebPushArea');
            const sendWebPush = document.getElementById('sendWebPush');

            // メッセージング オブジェクトの取得
            const messaging = firebase.messaging();

            // アプリにウェブ認証情報を設定する
            messaging.usePublicVapidKey("BNciTurF7WXKOWdzpMpi7OHTc7_1TPW26NlVXw4dgKlkKuDgovsOu_5CW1UUG5sD3J3RcXcy5AU1KP8MYQyONQM");

            // 権限要求
            function requestPermission() {
                // 通知を受信する権限を要求する
                messaging.requestPermission().then(function() {
                    // 現在の登録トークンの取得
                    messaging.getToken().then(function(token) {
                        textInstanceIdToken.value = token;
                        btnSubscribe.style.display = 'none';
                        btnUnSubscribe.style.display = 'block';
                        sendWebPushArea.style.display = 'block';
                        const req = {
                            "id": "0",
                            "token": token
                        }
                        const url = "http://localhost:8881/api/checktoken";
                        const res = fetchJSON(url, req);
                        console.log(res);
                    }).catch(function(err) {
                        textInstanceIdToken.value = 'トークンの取得に失敗しました（' + err + '）。';
                    });
                }).catch(function(err) {
                    textInstanceIdToken.value = '通知の許可が得られませんでした（' + err + '）。';
                });
            }

            // トークン削除
            function deleteToken() {
                // トークン取得
                messaging.getToken().then(function(currentToken) {
                    // トークン削除
                    messaging.deleteToken(currentToken).then(function() {
                        textInstanceIdToken.value = 'トークンが削除されました';
                        btnSubscribe.style.display = 'block';
                        btnUnSubscribe.style.display = 'none';
                        sendWebPushArea.style.display = 'none';
                        sendWebPush.value = '';
                    }).catch(function(err) {
                        textInstanceIdToken.value = 'トークンの削除に失敗しました（' + err + '）。';
                    });
                }).catch(function(err) {
                    textInstanceIdToken.value = 'トークンの取得に失敗しました（' + err + '）。';
                });
            }

            // 初期化
            window.onload = function() {
                // イベント登録
                btnSubscribe.onclick = requestPermission;
                btnUnSubscribe.onclick = deleteToken;
                // トークン取得
                messaging.getToken().then(function(currentToken) {
                    if (currentToken) {
                        // 本来ここでサーバにトークン送る処理
                        //sendTokenToServer(currentToken);
                        textInstanceIdToken.value = currentToken;
                        btnSubscribe.style.display = 'none';
                        btnUnSubscribe.style.display = 'block';
                        sendWebPushArea.style.display = 'block';
                        const req = {
                            "id": "0",
                            "token": currentToken
                        }
                        const url = "http://localhost:8881/api/checktoken";
                        const res = fetchJSON(url, req);
                        console.log(res);
                    } else {
                        // トークン無い場合
                        textInstanceIdToken.value = '通知の許可をしていません。「通知を許可する」を押してください。';
                    }
                }).catch(function(err) {
                    textInstanceIdToken.value = 'トークンの取得に失敗しました（' + err + '）。';
                });
            };
        </script>




        <!-- The core Firebase JS SDK is always required and must be listed first -->
        <script src="/__/firebase/7.19.0/firebase-app.js"></script>

        <!-- TODO: Add SDKs for Firebase products that you want to use
            https://firebase.google.com/docs/web/setup#available-libraries -->

        <!-- Initialize Firebase -->
        <script src="/__/firebase/init.js"></script>
    </body>
</html>